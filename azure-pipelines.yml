variables:
- group: dbt-pipeline-secrets  # REDSHIFT_HOST, REDSHIFT_USER, REDSHIFT_PASSWORD, REDSHIFT_DB, REDSHIFT_SCHEMA を登録

trigger:
  branches:
    include:
      - main

pool:
  vmImage: 'ubuntu-latest'

steps:
  - checkout: self

  # Python と dbt のセットアップ
  - task: UsePythonVersion@0
    inputs:
      versionSpec: '3.10'

  - script: |
      pip install dbt-core dbt-redshift
    displayName: 'Install dbt'

  # profiles.yml を作成
  - script: |
      mkdir -p ~/.dbt
      echo "
      redshift2:
        outputs:
          dev:
            dbname: $(REDSHIFT_DB)
            host: $(REDSHIFT_HOST)
            password: $(REDSHIFT_PASSWORD)
            port: 5439
            schema: $(REDSHIFT_SCHEMA)
            threads: 1
            type: redshift
            user: $(REDSHIFT_USER)
        target: dev
      " > ~/.dbt/profiles.yml
    displayName: 'Create dbt profiles.yml'

  # dbt の実行
  - script: |
      dbt deps
      dbt run
      dbt test
    displayName: 'Run dbt models and tests'
